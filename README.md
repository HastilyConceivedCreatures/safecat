# Safecat
![safecat logo, generated by stable diffusion and gimp](https://neiman.co.il/images/safecat.png)

A simple CLI tool to generate, sign, create, verify, and prove digital signatures using EdDSA *Baby Jubjub Elliptic Curve* signatures and a *Poseidon hash function*.

Safecat specializes in creating cryptographically signed certificates and proofs based on these certificates for zk applicatoins.

Browser through the safecat articles [on my blog](http://neimanslab.org/) for release notes and further detail.

## compile
Install Rust, and run `cargo build`. Last tested with `cargo 1.82.0`.

To use `safecat prove` you also need [Noir](https://noir-lang.org/docs/dev/getting_started/noir_installation) and [bb](https://github.com/AztecProtocol/aztec-packages/tree/master/barretenberg/bbup) from Aztec installed. It was last tested with `nargo 0.37.0` and `bb 0.61.0`.

## usage
1. `safecat generate`. Generates a new EdDSA Baby Jubjub Elliptic Curve private-public key.

    The private key is saved in a file `data/priv.key`, which is not encrypted! Unsafe indeed.

2. `safecat show-keys`. Shows the last generated private-public keys. You can choose which format to show, hex or detailed. Hex is simply a concatenation of the hex values of the public key's `x` and `y` elements. You need "detailed" if you want to verify the signature in Noir (it shows the x and y values of the key), and "hex" if you verify with Safecat.

    Here's how you show the detailed format:
    ```
    safecat show-keys --format detailed
    ```
    and here's how you show the hex format:
    ```
    safecat show-keys --format hex
    ```

3. `safecat sign <message>`. Signs a message using the private key located in data/priv.key. The message is hashed using the Poseidon hash function by default, but you can change it to SHA-256 using the --hash option. You can also choose a format as before (the hex signature is the concatenation of the hex format of the signature's r.x, r.y, s).
    ```
    safecat sign --hash sha256 --format hex "hello world"
    ```

4. `safecat sign-field <field>`. Same as `sign`, but instead of getting a message it accepts an element of the BN254 field. This may be the Poseidon hash of some message, but it can also be something else. Example:
    ```
    safecat sign-field 7185613633770928202545956049438992141449192152982569455300607652365873326347
    ```

5. `safecat verify <message> <signature> <public key>`. Verifies an existing signature of a message. By default, it assumes the message was hashed using Poseidon, but you can change it to SHA-256 using the --hash option like before. The signature and public key must be given in a hex form (see definitions above). 

    Verify commands are a bit long since the signature and public keys are long, so here's an example of how to use them. It doesn't look pretty.

    In later versions, we'll allow reading the parameters from a file or feeding them interactively.

    ```
    safecat verify "hello world" 245a157dc8e23ea8a0ab41b1c2d95ee7d59db5b76cba54b6f10630e5e0aefbdd140996400320386a9a2ec4b06ea7d1c885cd311751445ea171af1ab64dba5ace0420d34429497da49443ae35deb8e3daa745dc0e776df3703640078a67982cad 12055e5d761fd705d1f234770fc55b2cfdfd91e741d8f43b2a88cb5a88f9c1c01061ca2f21151da2903e7ccdf11dbda65c20851dd1df4ac522431041ea1738f9
    ```

5. `safecat attest <certificate_type>`. Creates certificates interactively. The certificate type is a string like "babyjubjub" (which is also the default value). Safecat searches for the toml certificate format specification in the folder data/certificate-formats (So for "babyjubjub" it would be "data/certificate-formats/babyjubjub.toml".

    Example usage:

    ```
    safecat attest --certificate-type babyjubjub
    ```

    Certificates are saved in `certs/created` folder.

    An explanation of certificates .toml format files is given below.

6. `safecat prove <cert_format> <proof_format>`. Creates a zero-knowledge proof using Nargo and Barretenberg (by Ztec), based on specified certificate and proof formats. By default, the command assumes the `babyjubjub` certificate format and `personhood` proof format, which are the most common use cases.

    Safecat searches for the `.toml` certificate and proof format specifications in the `data/formats` folder. For example, specifying the certificate format as `babyjubjub` and the proof format as `personhood` would look for `data/formats/babyjubjub/format.toml` and `data/formats/babyjubjub/proofs/personhood/proof.toml`, respectively.

    Example usage:

    ```
    safecat prove --cert-format babyjubjub --proof-format personhood
    ```

    Additional flags:

    Flag `--no-execute`. Skips execution if set. This flag is optional and can be triggered with `-n` or `--no-execute`. If set then a Noir program for the proof is set but not executed.

    Proofs are saved in the `output` folder.


## Directories structure
Safecat has at this stage quite a strict data and output directory structure. If you're adding new formats, make sure to place it in the right place or all hell will break loose (i.e., a run-time error).

The constants are set in `consts.rs`, we'll write next to each directory what the constant name is.

### Data directory (`DATA_DIR`)
The data Safecat uses.
- `/formats` (`CERTIFICATE_FORMATS`). Holds the formats of supported certificates. Each folder is actually a type of certificate. The file `format.toml` inside the folder specifies the certificate format, and there is a subfolder for each possible proof. Each proof folder contains `proof.toml`, which describes the input parameters, and the source code of the Noir program for the proof. The toml files are later used to ask for input interactively from the user when creating a certificate of proof.

    We don't specify here in detail the format of the `.toml` file at this stage, but they are quite self-explanatory if you want to create new ones.

- 'noir_project_template' (`NOIR_TEMPLATE_FOLDER`). This folder contains a template for a Noir project. When the user proves something the program copies this template and changes it based on the specific proof format for the `format` folder (described above).

- `societies`. This folder includes JSON files of `societies`. A society is a collection of public keys of entities that are trusted to create certificates. When you create a proof, you often specify for which "society" the certificates are made. Then whoever verifies the proofs knows that the certificates that were made to use it come from trusted entities. A society file is a Merkle tree created from trusted entities. We use [MPZ](https://github.com/eyalron33/mpz/) tool to create such files.

- 'test_data'. You can ignore this folder for the time being. It got some data we generated for internal testing.

### Output directory (`OUTPUT_DIR`)
This directory contains the output of Safecat. Currently: 
- `priv.key` (`PRIVATE_KEY_FILENAME`): your last generated private key, unencrypted!
- List of proofs you generated, a proof name includes the timestamp of when it was generated, e.g., `proof_20241111_094857`.
- Folder of Noir programs for proofs which were generated with the `safecat prove` using the `-n` flag. This flag tells Safecat to create a Noir program for the proof but without executing it.

## Limitations
- Poseidon hash is limited to strings of 496 characters. This can be extended to arbitrary length but it's left as a task for later versions.
- The proving system doesn't work.
- ... plenty of other limitations, this is all WIP! I know I've been saying it for half a year already. But well, at least I'm consistent!
